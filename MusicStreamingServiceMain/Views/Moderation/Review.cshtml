@model MusicStreamingService.Models.Track
@{
    ViewData["Title"] = "Модерация трека: " + Model.Title;
}

<div class="container">
    <h2>Модерация трека</h2>

    <div class="card">
        <div class="card-body">
            <h4 class="card-title">@Model.Title</h4>

            <div class="row mt-4">
                <div class="col-md-6">
                    <p><strong>Исполнитель:</strong> @Model.Artist?.Name</p>
                    <p><strong>Жанр:</strong> @Model.Genre?.Name</p>
                    <p><strong>Альбом:</strong> @(Model.Album?.Title ?? "Не указан")</p>
                    <p><strong>Длительность:</strong> @TimeSpan.FromSeconds(Model.Duration).ToString(@"mm\:ss")</p>
                    <p><strong>Файл:</strong> @Model.FilePath</p>
                </div>
                <div class="col-md-6">
                    <!-- аудиоплеер -->
                    <h5>Прослушивание трека:</h5>
                    <div id="audioPlayerContainer">
                        <audio id="moderationAudioPlayer" controls style="width: 100%;">
                            <source src="@Url.Action("StreamForModeration", "Tracks", new { id = Model.Id })" type="audio/mpeg">
                            Ваш браузер не поддерживает аудио элемент.
                        </audio>

                        @* <div class="mt-3">
                            <div id="playerStatus" class="alert alert-info" style="display: none;"></div>
                            <button id="testPlayBtn" class="btn btn-primary">
                                <i class="fas fa-play"></i> Протестировать воспроизведение
                            </button>
                            <button id="refreshBtn" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Перезагрузить плеер
                            </button>
                        </div> *@
                    </div>
                </div>
            </div>

            <!-- Формы для модерации -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <form method="post" action="/Moderation/Approve/@Model.Id">
                        <div class="form-group">
                            <label for="approveComment">Комментарий (опционально):</label>
                            <textarea name="comment" id="approveComment" class="form-control" rows="2" placeholder="Комментарий при одобрении"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg">✅ Одобрить трек</button>
                    </form>
                </div>
                <div class="col-md-6">
                    <form method="post" action="/Moderation/Reject/@Model.Id">
                        <div class="form-group">
                            <label for="rejectComment">Причина отклонения:</label>
                            <textarea name="comment" id="rejectComment" class="form-control" rows="2" placeholder="Укажите причину отклонения" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger btn-lg">❌ Отклонить трек</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="/Moderation" class="btn btn-secondary">← Назад к списку</a>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const audioPlayer = document.getElementById('moderationAudioPlayer');
            const playerStatus = document.getElementById('playerStatus');
            const testPlayBtn = document.getElementById('testPlayBtn');
            const refreshBtn = document.getElementById('refreshBtn');

            console.log('Audio player initialized for track: @Model.Id');
            console.log('Audio source:', audioPlayer.src);

            // Обработчики событий аудио
            audioPlayer.addEventListener('error', function(e) {
                console.error('Audio error:', e);
                playerStatus.textContent = 'Ошибка воспроизведения: ' + getAudioError(audioPlayer.error);
                playerStatus.className = 'alert alert-danger';
                playerStatus.style.display = 'block';
            });

            audioPlayer.addEventListener('loadedmetadata', function() {
                console.log('Audio metadata loaded, duration:', audioPlayer.duration);
                playerStatus.textContent = 'Аудио загружено. Длительность: ' + formatTime(audioPlayer.duration);
                playerStatus.className = 'alert alert-success';
                playerStatus.style.display = 'block';

                // Автоскрытие через 5 секунд
                setTimeout(() => {
                    playerStatus.style.display = 'none';
                }, 5000);
            });

            audioPlayer.addEventListener('canplay', function() {
                console.log('Audio can play');
                playerStatus.textContent = 'Аудио готово к воспроизведению';
                playerStatus.className = 'alert alert-info';
                playerStatus.style.display = 'block';

                setTimeout(() => {
                    playerStatus.style.display = 'none';
                }, 3000);
            });

            // Кнопка тестирования
            testPlayBtn.addEventListener('click', function() {
                console.log('Testing audio playback...');

                // Пробуем загрузить аудио через fetch для проверки
                fetch(audioPlayer.src)
                    .then(response => {
                        console.log('Fetch response status:', response.status);
                        if (response.ok) {
                            playerStatus.textContent = 'Аудио файл доступен (HTTP ' + response.status + ')';
                            playerStatus.className = 'alert alert-success';

                            // Пробуем воспроизвести
                            audioPlayer.play().then(() => {
                                playerStatus.textContent = 'Воспроизведение успешно начато!';
                                playerStatus.className = 'alert alert-success';
                            }).catch(error => {
                                playerStatus.textContent = 'Ошибка воспроизведения: ' + error.message;
                                playerStatus.className = 'alert alert-warning';
                            });
                        } else {
                            playerStatus.textContent = 'Ошибка загрузки файла (HTTP ' + response.status + ')';
                            playerStatus.className = 'alert alert-danger';
                        }
                        playerStatus.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        playerStatus.textContent = 'Ошибка сети: ' + error.message;
                        playerStatus.className = 'alert alert-danger';
                        playerStatus.style.display = 'block';
                    });
            });

            // Кнопка перезагрузки
            refreshBtn.addEventListener('click', function() {
                console.log('Reloading audio player...');
                audioPlayer.load();
                playerStatus.textContent = 'Плеер перезагружен';
                playerStatus.className = 'alert alert-info';
                playerStatus.style.display = 'block';

                setTimeout(() => {
                    playerStatus.style.display = 'none';
                }, 2000);
            });

            // Автоматически пробуем воспроизвести через 1 секунду
            setTimeout(() => {
                console.log('Attempting to play audio...');
                audioPlayer.play().catch(error => {
                    console.log('Auto-play prevented:', error.message);
                    playerStatus.textContent = 'Нажмите "Протестировать воспроизведение" для проверки аудио';
                    playerStatus.className = 'alert alert-warning';
                    playerStatus.style.display = 'block';
                });
            }, 1000);
        });

        function getAudioError(error) {
            if (!error) return 'Неизвестная ошибка';

            switch(error.code) {
                case error.MEDIA_ERR_ABORTED:
                    return 'Воспроизведение отменено';
                case error.MEDIA_ERR_NETWORK:
                    return 'Ошибка сети';
                case error.MEDIA_ERR_DECODE:
                    return 'Ошибка декодирования аудио';
                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                    return 'Формат аудио не поддерживается';
                default:
                    return 'Неизвестная ошибка: ' + error.code;
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
}