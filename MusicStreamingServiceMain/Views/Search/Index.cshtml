@model MusicStreamingService.Controllers.SearchViewModel
@{
    ViewData["Title"] = $"Результаты поиска: {Model.Query}";
}

<div class="container">
    <h2 class="mb-4">Результаты поиска: "<span class="text-primary">@Model.Query</span>"</h2>

    @if (Model.TotalResults == 0)
    {
        <!-- Без изменений -->
        <div class="alert alert-info">
            <h5>Ничего не найдено</h5>
            <p>По запросу "<strong>@Model.Query</strong>" ничего не найдено.</p>
            <p>Попробуйте изменить запрос или искать по:</p>
            <ul>
                <li>Названию трека</li>
                <li>Имени исполнителя</li>
                <li>Названию альбома</li>
            </ul>
            <a href="/" class="btn btn-primary mt-2">Вернуться на главную</a>
        </div>
    }
    else
    {
        <div class="alert alert-light mb-4">
            Найдено результатов: <strong>@Model.TotalResults</strong>
        </div>

        <!-- ТРЕКИ -->
        @if (Model.Tracks.Any())
        {
            <div class="mb-5">
                <h4 class="mb-3">
                    <i class="fas fa-music me-2"></i> Треки (@Model.Tracks.Count)
                </h4>
                <div class="row">
                    @foreach (var track in Model.Tracks)
                    {
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 search-track-card">
                                <div class="search-track-image">
                                    @if (!string.IsNullOrEmpty(track.CoverImage))
                                    {
                                        <img src="@track.CoverImage" alt="@track.Title"
                                             class="card-img-top search-img" />
                                    }
                                    else
                                    {
                                        <div class="search-placeholder" style="background: @track.ColorHash;">
                                            <i class="fas fa-music fa-2x"></i>
                                        </div>
                                    }
                                    <button class="search-play-btn" onclick="playTrackSearch('@track.Id', '@track.Title', '@track.Artist?.Name', @track.Duration)">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title text-truncate" title="@track.Title">@track.Title</h6>
                                    <p class="card-text small text-muted mb-1">
                                        <i class="fas fa-user me-1"></i> @track.Artist?.Name
                                    </p>
                                    @if (!string.IsNullOrEmpty(track.Album?.Title))
                                    {
                                        <p class="card-text small text-muted">
                                            <i class="fas fa-compact-disc me-1"></i> @track.Album.Title
                                        </p>
                                    }
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="badge bg-secondary">
                                            @TimeSpan.FromSeconds(track.Duration).ToString(@"mm\:ss")
                                        </span>
                                        <div class="search-actions">
                                            <a href="/Tracks/Play/@track.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-play"></i>
                                            </a>
                                            @if (User.Identity.IsAuthenticated)
                                            {
                                                <button class="btn btn-sm btn-outline-secondary add-to-playlist-btn"
                                                        data-track-id="@track.Id">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- АРТИСТЫ -->
        @if (Model.Artists.Any())
        {
            <div class="mb-5">
                <h4 class="mb-3">
                    <i class="fas fa-user me-2"></i> Исполнители (@Model.Artists.Count)
                </h4>
                <div class="row">
                    @foreach (var artist in Model.Artists)
                    {
                        <div class="col-md-4 col-lg-3 mb-4">
                            <div class="card h-100 search-artist-card">
                                <div class="search-artist-image">
                                    @if (!string.IsNullOrEmpty(artist.PhotoPath))
                                    {
                                        <img src="@artist.PhotoPath" alt="@artist.Name"
                                             class="card-img-top search-img rounded-circle" />
                                    }
                                    else
                                    {
                                        <div class="search-placeholder rounded-circle"
                                             style="background: @Model.GetArtistColor(artist.Id);">
                                            <i class="fas fa-user fa-2x"></i>
                                        </div>
                                    }
                                </div>
                                <div class="card-body text-center">
                                    <h6 class="card-title mb-2">@artist.Name</h6>
                                    @if (!string.IsNullOrEmpty(artist.Description))
                                    {
                                        <p class="card-text small text-muted text-truncate-2">
                                            @artist.Description
                                        </p>
                                    }
                                    <div class="mt-3">
                                        <a href="#" class="btn btn-sm btn-outline-primary w-100">
                                            <i class="fas fa-music me-1"></i> Треки
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- АЛЬБОМЫ -->
        @if (Model.Albums.Any())
        {
            <div class="mb-5">
                <h4 class="mb-3">
                    <i class="fas fa-compact-disc me-2"></i> Альбомы (@Model.Albums.Count)
                </h4>
                <div class="row">
                    @foreach (var album in Model.Albums)
                    {
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 search-album-card">
                                <div class="search-album-image">
                                    @if (!string.IsNullOrEmpty(album.CoverPath))
                                    {
                                        <img src="@album.CoverPath" alt="@album.Title"
                                             class="card-img-top search-img" />
                                    }
                                    else
                                    {
                                        <div class="search-placeholder"
                                             style="background: @Model.GetAlbumColor(album.Id);">
                                            <i class="fas fa-compact-disc fa-2x"></i>
                                        </div>
                                    }
                                    <button class="search-play-btn"
                                            onclick="playAlbumFirstTrack(@album.Id)">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title text-truncate" title="@album.Title">@album.Title</h6>
                                    <p class="card-text small text-muted mb-2">
                                        <i class="fas fa-user me-1"></i> @album.Artist?.Name
                                    </p>
                                    @if (album.ReleaseDate.HasValue)
                                    {
                                        <p class="card-text small text-muted mb-3">
                                            <i class="fas fa-calendar me-1"></i> @album.ReleaseDate.Value.Year
                                        </p>
                                    }
                                    <div class="d-grid">
                                        <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-list me-1"></i> Показать треки
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    <div class="mt-4">
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> На главную
        </a>
    </div>
</div>

@section Scripts {
    <script>
        // Функция для воспроизведения трека из поиска
        function playTrackSearch(trackId, trackTitle, artistName, duration) {
            if (typeof window.playTrackWithAdCheck === 'function') {
                window.playTrackWithAdCheck(trackId, trackTitle, artistName, duration);
            } else if (typeof window.playTrack === 'function') {
                window.playTrack(trackId, trackTitle, artistName, duration);
            } else {
                // Fallback: открываем страницу трека
                window.location.href = `/Tracks/Play/${trackId}`;
            }
        }

        // Функция для воспроизведения первого трека альбома
        function playAlbumFirstTrack(albumId) {
            // В будущем можно реализовать получение первого трека альбома
            // А пока просто показываем алерт
            alert('Функция воспроизведения альбома будет реализована позже');
        }

        // Обработка кнопок добавления в плейлист
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.add-to-playlist-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const trackId = this.dataset.trackId;
                    console.log('Adding track to playlist from search:', trackId);

                    // Используем существующую функцию или показываем модальное окно
                    if (typeof window.addToPlaylist === 'function') {
                        window.addToPlaylist(trackId);
                    } else {
                        // Загружаем и показываем модальное окно
                        fetch(`/Playlists/AddToPlaylistModal?trackId=${trackId}`)
                            .then(response => response.text())
                            .then(html => {
                                const div = document.createElement('div');
                                div.innerHTML = html;
                                document.body.appendChild(div.firstElementChild);

                                const modal = new bootstrap.Modal(
                                    document.getElementById('addToPlaylistModal')
                                );
                                modal.show();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Ошибка при загрузке модального окна');
                            });
                    }
                });
            });

            // Обработка кликов по карточкам
            document.querySelectorAll('.search-track-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Если клик не по кнопке или ссылке внутри карточки
                    if (!e.target.closest('button') && !e.target.closest('a')) {
                        const trackId = this.querySelector('.add-to-playlist-btn')?.dataset.trackId;
                        if (trackId) {
                            window.location.href = `/Tracks/Play/${trackId}`;
                        }
                    }
                });
            });

            document.querySelectorAll('.search-artist-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('button') && !e.target.closest('a')) {
                        const artistName = this.querySelector('.card-title')?.textContent;
                        if (artistName) {
                            // Можно добавить переход на страницу артиста
                            alert(`Страница артиста "${artistName}" будет реализована позже`);
                        }
                    }
                });
            });

            document.querySelectorAll('.search-album-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('button') && !e.target.closest('a')) {
                        const albumId = this.querySelector('.search-play-btn')?.getAttribute('onclick')?.match(/\d+/)?.[0];
                        if (albumId) {
                            // Можно добавить переход на страницу альбома
                            alert(`Страница альбома будет реализована позже`);
                        }
                    }
                });
            });
        });
    </script>
}