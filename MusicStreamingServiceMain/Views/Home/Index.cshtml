@model MusicStreamingService.Controllers.HomeViewModel
@{
    ViewData["Title"] = "Музыкальный стриминговый сервис";
}

<div class="hero-section">
    <div class="container">
        <h1 class="hero-title">Слушайте музыку, которая вам нравится</h1>
        <p class="hero-subtitle">Миллионы треков, персональные рекомендации и удобные плейлисты</p>
        <div class="hero-actions">
            <a href="/Account/Profile" class="btn btn-primary btn-lg">Начать слушать бесплатно</a>
            <a href="/Subscription/Plans" class="btn btn-outline btn-lg">Узнать о подписке</a>
        </div>
    </div>
</div>

<div class="container main-content">
    <!-- Поиск -->
    <div class="search-section">
        <form asp-controller="Search" asp-action="Index" method="get" class="search-form">
            <div class="search-input-group">
                <input type="text" name="query" class="search-input"
                       placeholder="Исполнитель, трек или альбом"
                       required
                       value="@ViewBag.SearchQuery" />
                <button type="submit" class="search-button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Популярные треки (Горизонтальная лента) -->
    <section class="section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0">Треки для вас</h2>
            <span class="text-muted"><i class="fas fa-random me-1"></i> Случайная подборка</span>
        </div>

        <div class="horizontal-scroll-container">
            @foreach (var track in Model.PopularTracks)
            {
                <div class="track-card" data-track-id="@track.Id">
                    <div class="track-image">
                        <!-- Используем обложку из свойства CoverImage -->
                        @if (!string.IsNullOrEmpty(track.CoverImage))
                        {
                            <img src="@track.CoverImage" alt="@track.Title"
                                 style="width: 100%; height: 100%; object-fit: cover;" />
                        }
                        else
                        {
                            <!-- Fallback на цветной placeholder -->
                            <div style="width: 100%; height: 100%; background: @track.ColorHash;
                                                display: flex; align-items: center;
                                                justify-content: center; color: white; font-size: 2rem;">
                                <i class="bi bi-music"></i>
                            </div>
                        }
                        <button class="play-button" data-track-id="@track.Id">
                            <i class="bi bi-play"></i>
                        </button>
                    </div>
                    <div class="track-info">
                        <h3 class="track-title text-truncate" title="@track.Title">@track.Title</h3>
                        <p class="track-artist text-truncate">@track.Artist?.Name</p>
                        <p class="track-album text-truncate">@track.Album?.Title</p>
                    </div>
                    <div class="track-actions">
                        <span class="track-duration">@TimeSpan.FromSeconds(track.Duration).ToString(@"mm\:ss")</span>
                        <button class="add-to-playlist-btn"
                                data-track-id="@track.Id"
                                title="Добавить в плейлист">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </section>

    <!-- "Избранные исполнители" (Горизонтальная лента) -->
    <section class="section">
        <h2 class="section-title">Исполнители</h2>

        <div class="horizontal-scroll-container">
            @foreach (var artist in Model.FeaturedArtists)
            {
                <div class="artist-card">
                    <div class="artist-image">
                        @if (!string.IsNullOrEmpty(artist.PhotoPath))
                        {
                            <img src="@artist.PhotoPath" alt="@artist.Name" class="artist-photo" />
                        }
                        else
                        {
                            <div class="no-photo-placeholder">
                                <i class="bi bi-user"></i>
                            </div>
                        }
                    </div>
                    <div class="artist-info">
                        <h3 class="artist-name text-truncate">@artist.Name</h3>
                        <p class="artist-description">
                            @(artist.Description?.Length > 50 ? artist.Description.Substring(0, 50) + "..." : artist.Description)
                        </p>
                    </div>
                </div>
            }
        </div>
    </section>
</div>

<!-- Музыкальный плеер -->
<div class="music-player" id="musicPlayer" style="display: none;">
    @* ... содержимое плеера ... *@
    <div class="player-controls">
        <button class="control-btn" onclick="previousTrack()">
            <i class="bi bi-skip-backward"></i>
        </button>
        <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">
            <i class="bi bi-play" id="playIcon"></i>
        </button>
        <button class="control-btn" onclick="nextTrack()">
            <i class="bi bi-skip-forward"></i>
        </button>
    </div>

    <div class="player-info">
        <div class="track-now-playing">
            <span class="track-name" id="currentTrackName">Выберите трек</span>
            <span class="artist-name" id="currentArtistName">для воспроизведения</span>
        </div>
    </div>

    <div class="player-progress">
        <div class="progress-bar" onclick="seek(event)">
            <div class="progress" id="progressBar"></div>
        </div>
        <div class="time-display">
            <span class="current-time" id="currentTime">0:00</span>
            <span class="total-time" id="totalTime">0:00</span>
        </div>
    </div>

    <div class="player-options">
        <button class="option-btn" onclick="toggleMuteGlobal()">
            <i class="bi bi-volume-up" id="volumeIcon"></i>
        </button>
        <input type="range" min="0" max="100" value="50" class="volume-slider"
               id="volumeSlider" oninput="setVolumeGlobal(this.value)">
    </div>
</div>

@section Scripts {
    <script>
        // Глобальные переменные плеера
        let currentAudio = null;
        let currentTrackId = null;
        let isPlaying = false;
        let currentTrackIndex = 0;
        let tracks = [];
        let currentPlayingTrackId = null;

        // Инициализация треков из страницы
        document.addEventListener('DOMContentLoaded', function() {
            const trackCards = document.querySelectorAll('.track-card');
            tracks = Array.from(trackCards).map(card => ({
                id: card.dataset.trackId,
                title: card.querySelector('.track-title').textContent,
                artist: card.querySelector('.track-artist').textContent,
                duration: parseInt(card.querySelector('.track-duration').textContent.replace(':', ''))
            }));
        });

        // Воспроизведение трека
        function playTrack(trackId, title, artist, duration) {
            if (currentAudio) {
                currentAudio.pause();
            }
            document.getElementById('musicPlayer').style.display = 'flex';
            document.getElementById('currentTrackName').textContent = title;
            document.getElementById('currentArtistName').textContent = artist;
            document.getElementById('totalTime').textContent = formatTime(duration);

            currentAudio = new Audio(`/Tracks/Stream/${trackId}`);
            currentTrackId = trackId;

            currentAudio.addEventListener('loadedmetadata', function() {
                document.getElementById('totalTime').textContent = formatTime(currentAudio.duration);
            });

            currentAudio.addEventListener('timeupdate', function() {
                updateProgress();
            });

            currentAudio.addEventListener('ended', function() {
                nextTrack();
            });

            currentAudio.play();
            isPlaying = true;
            updatePlayButton();
            fetch(`/Tracks/RecordPlay/${trackId}`);
        }

        function togglePlay() {
            if (!currentAudio) return;
            if (isPlaying) {
                currentAudio.pause();
            } else {
                currentAudio.play();
            }
            isPlaying = !isPlaying;
            updatePlayButton();
        }

        function updatePlayButton() {
            const playIcon = document.getElementById('playIcon');
            if (isPlaying) {
                playIcon.className = 'bi bi-pause';
            } else {
                playIcon.className = 'bi bi-play';
            }
        }

        function updateProgress() {
            if (!currentAudio) return;
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(currentAudio.currentTime);
        }

        function seek(event) {
            if (!currentAudio) return;
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            currentAudio.currentTime = percent * currentAudio.duration;
        }

        function setVolume(value) {
            if (currentAudio) {
                currentAudio.volume = value / 100;
            }
        }

        function toggleMute() {
            if (!currentAudio) return;
            currentAudio.muted = !currentAudio.muted;
            const volumeIcon = document.getElementById('volumeIcon');
            volumeIcon.className = currentAudio.muted ? 'bi bi-volume-mute' : 'bi bi-volume-up';
        }

        function nextTrack() {
            if (tracks.length === 0) return;
            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            const track = tracks[currentTrackIndex];
            playTrack(track.id, track.title, track.artist, track.duration);
        }

        function previousTrack() {
            if (tracks.length === 0) return;
            currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            const track = tracks[currentTrackIndex];
            playTrack(track.id, track.title, track.artist, track.duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function isUserAuthenticated() {
            return document.cookie.includes('.AspNetCore.Cookies');
        }

        function openAddToPlaylistModal(trackId) {
            if (!isUserAuthenticated()) {
                alert('Для добавления треков в плейлисты необходимо войти в систему');
                window.location.href = '/Account/Login';
                return;
            }
            fetch(`/Playlists/AddToPlaylistModal?trackId=${trackId}`)
                .then(response => response.text())
                .then(html => {
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = html;
                    document.body.appendChild(modalContainer.firstElementChild);
                    const modal = new bootstrap.Modal(document.getElementById('addToPlaylistModal'));
                    modal.show();
                });
        }

        window.playTrackWithAdCheck = function(trackId, title, artist, duration) {
            checkSubscriptionAndShowAd(function() {
                if (typeof playTrack === 'function') {
                    playTrack(trackId, title, artist, duration);
                }
            });
        };
    </script>
}