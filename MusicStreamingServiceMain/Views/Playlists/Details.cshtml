@model MusicStreamingService.Models.Playlist
@{
    ViewData["Title"] = Model.Title;
}

<div class="container" style="padding-bottom: 100px;">
    <!-- Добавили отступ снизу для плеера -->
    <!-- Заголовок плейлиста -->
    <div class="playlist-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-3">
                <div class="playlist-cover-large">
                    @if (Model.PlaylistTracks.Any())
                    {
                        <div class="cover-image-large" style="background-color: #6c757d; height: 200px;">
                            <i class="fas fa-music fa-5x text-white"></i>
                        </div>
                    }
                    else
                    {
                        <div class="cover-image-large empty-cover" style="background-color: #e9ecef; height: 200px;">
                            <i class="fas fa-music fa-5x text-secondary"></i>
                        </div>
                    }
                </div>
            </div>
            <div class="col-md-9">
                <div class="playlist-info">
                    <span class="badge @(Model.Visibility == MusicStreamingService.Models.PlaylistVisibility.Public ? "bg-success" : "bg-secondary") mb-2">
                        @Model.Visibility
                    </span>
                    <h1 class="display-6">@Model.Title</h1>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="lead">@Model.Description</p>
                    }
                    <div class="playlist-meta">
                        <span class="me-3">
                            <i class="fas fa-user me-1"></i> @Model.User.Username
                        </span>
                        <span class="me-3">
                            <i class="fas fa-music me-1"></i> @Model.TrackCount треков
                        </span>
                        <span class="me-3">
                            <i class="fas fa-clock me-1"></i> @TimeSpan.FromSeconds(Model.TotalDuration).ToString(@"hh\:mm\:ss")
                        </span>
                        <span>
                            <i class="fas fa-calendar me-1"></i> @Model.CreatedDate.ToString("dd.MM.yyyy")
                        </span>
                    </div>
                    <div class="playlist-actions mt-3">
                        <!-- Кнопка "Слушать" запускает первый трек -->
                        <button class="btn btn-primary btn-lg me-2" onclick="playFirstTrack()">
                            <i class="fas fa-play me-1"></i> Слушать
                        </button>
                        @if (User.Identity?.Name == Model.User.Username)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-secondary btn-lg me-2">
                                <i class="fas fa-edit me-1"></i> Редактировать
                            </a>
                            <form asp-action="Delete" asp-route-id="@Model.Id" method="post"
                                  onsubmit="return confirm('Удалить плейлист?');" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-danger btn-lg">
                                    <i class="fas fa-trash me-1"></i> Удалить
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список треков -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list-music me-2"></i> Треки в плейлисте
                <span class="badge bg-secondary ms-2">@Model.TrackCount</span>
                @if (User.Identity?.Name == Model.User.Username && Model.PlaylistTracks.Any())
                {
                    <small class="text-muted ms-2">(перетащите треки для изменения порядка)</small>
                }
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.PlaylistTracks.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="playlistTracksTable">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Название</th>
                                <th>Исполнитель</th>
                                <th>Альбом</th>
                                <th style="width: 100px;">Длительность</th>
                                <th style="width: 100px;">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="playlistTracksBody">
                            @foreach (var playlistTrack in Model.PlaylistTracks.OrderBy(pt => pt.Position))
                            {
                                var track = playlistTrack.Track;
                                <!-- Добавлены data-атрибуты для JS плеера -->
                                <tr class="track-row"
                                    data-track-id="@track.Id"
                                    data-track-row-id="@track.Id"
                                    data-position="@playlistTrack.Position"
                                    data-title="@track.Title"
                                    data-artist="@(track.Artist?.Name ?? "Неизвестный")"
                                    data-duration="@track.Duration">

                                    <td class="position-cell align-middle">
                                        <!-- Элемент для перетаскивания -->
                                        <div class="drag-handle" style="cursor: move; display: inline-block; margin-right: 10px;">
                                            <i class="fas fa-arrows-alt text-muted"></i>
                                        </div>
                                        <!-- Кнопка Play -->
                                        <button class="btn btn-sm btn-light rounded-circle play-track-btn"
                                                onclick="playTrackFromList('@track.Id')">
                                            <i class="fas fa-play text-primary"></i>
                                        </button>
                                    </td>
                                    <td class="align-middle">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            @if (!string.IsNullOrEmpty(track.CoverImage))
                                            {
                                                <img src="@track.CoverImage" alt="@track.Title"
                                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" />
                                            }
                                            <div class="cursor-pointer" onclick="playTrackFromList('@track.Id')">
                                                <strong>@track.Title</strong>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle">@track.Artist?.Name</td>
                                    <td class="align-middle">@track.Album?.Title</td>
                                    <td class="align-middle">@TimeSpan.FromSeconds(track.Duration).ToString(@"mm\:ss")</td>
                                    <td class="align-middle">
                                        <form method="post"
                                              action="/Playlists/RemoveTrack"
                                              class="d-inline"
                                              onsubmit="return confirm('Удалить этот трек из плейлиста?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="playlistId" value="@Model.Id" />
                                            <input type="hidden" name="trackId" value="@track.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Удалить из плейлиста">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-music fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Плейлист пуст</h5>
                    <p class="text-muted">Добавьте треки в этот плейлист</p>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Назад к моим плейлистам
        </a>
    </div>
</div>

<!-- === МУЗЫКАЛЬНЫЙ ПЛЕЕР (Скопировано из Home/Index.cshtml) === -->
<div class="music-player" id="musicPlayer" style="display: none;">
    <div class="player-controls">
        <button class="control-btn" onclick="previousTrack()">
            <i class="bi bi-skip-backward"></i>
        </button>
        <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">
            <i class="bi bi-play" id="playIcon"></i>
        </button>
        <button class="control-btn" onclick="nextTrack()">
            <i class="bi bi-skip-forward"></i>
        </button>
    </div>

    <div class="player-info">
        <div class="track-now-playing">
            <span class="track-name" id="currentTrackName">Выберите трек</span>
            <span class="artist-name" id="currentArtistName">для воспроизведения</span>
        </div>
    </div>

    <div class="player-progress">
        <div class="progress-bar" onclick="seek(event)">
            <div class="progress" id="progressBar"></div>
        </div>
        <div class="time-display">
            <span class="current-time" id="currentTime">0:00</span>
            <span class="total-time" id="totalTime">0:00</span>
        </div>
    </div>

    <div class="player-options">
        <button class="option-btn" onclick="toggleMuteGlobal()">
            <i class="bi bi-volume-up" id="volumeIcon"></i>
        </button>
        <input type="range" min="0" max="100" value="50" class="volume-slider"
               id="volumeSlider" oninput="setVolumeGlobal(this.value)">
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f8f9fa;
        }

        .sortable-chosen {
            background-color: #e3f2fd !important;
        }

        .drag-handle {
            cursor: move;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
    <script>
        // === ЛОГИКА ПЛЕЕРА И DRAG & DROP ===

        let currentTrackIndex = 0;
        let tracks = [];
        let playlistId = @Model.Id;
        let sortableInstance = null;

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Собираем массив треков из таблицы
            const trackRows = document.querySelectorAll('.track-row');
            tracks = Array.from(trackRows).map(row => ({
                id: row.dataset.trackId,
                title: row.dataset.title,
                artist: row.dataset.artist,
                duration: parseInt(row.dataset.duration),
                position: parseInt(row.dataset.position)
            }));

            console.log("Плейлист загружен, треков:", tracks.length);

            // 2. Инициализация Drag & Drop (только для владельца)
            @if (User.Identity?.Name == Model.User.Username)
            {
                    <text>
                    initializeSortable();
                    </text>
            }

            // 3. ПЕРЕОПРЕДЕЛЕНИЕ КНОПОК ПЛЕЕРА
            setTimeout(function() {
                const prevBtn = document.querySelector('.player-controls .control-btn:first-child');
                const nextBtn = document.querySelector('.player-controls .control-btn:last-child');
                const playBtn = document.querySelector('.player-controls .play-btn');

                if (prevBtn) {
                    prevBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.previousTrack();
                    };
                }

                if (nextBtn) {
                    nextBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.nextTrack();
                    };
                }

                if (playBtn) {
                    playBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.togglePlay();
                    };
                }
            }, 200);
        });

        // === ФУНКЦИИ ДЛЯ DRAG & DROP ===

        function initializeSortable() {
            const tbody = document.getElementById('playlistTracksBody');
            if (tbody) {
                sortableInstance = Sortable.create(tbody, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function(evt) {
                        // После изменения порядка сохраняем на сервере
                        saveNewOrder();
                    }
                });
            }
        }

        async function saveNewOrder() {
            try {
                const rows = document.querySelectorAll('.track-row');
                const trackIds = Array.from(rows).map(row => parseInt(row.dataset.trackId));

                console.log('Saving new order for playlist', playlistId, ':', trackIds);

                // Получаем токен CSRF
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('/Playlists/Reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        'playlistId': playlistId,
                        '__RequestVerificationToken': token,
                        ...trackIds.reduce((acc, id, index) => {
                            acc[`trackIds[${index}]`] = id;
                            return acc;
                        }, {})
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    // Обновляем позиции в данных
                    rows.forEach((row, index) => {
                        row.dataset.position = index;
                    });

                    // Обновляем массив tracks
                    trackIds.forEach((trackId, index) => {
                        const track = tracks.find(t => t.id == trackId);
                        if (track) {
                            track.position = index;
                        }
                    });
                } else {
                    showToast(data.message || 'Ошибка при сохранении порядка', 'error');
                    // Восстанавливаем исходный порядок в случае ошибки
                    restoreOriginalOrder();
                }
            } catch (error) {
                console.error('Error saving playlist order:', error);
                showToast('Произошла ошибка при сохранении: ' + error.message, 'error');
                restoreOriginalOrder();
            }
        }

        function restoreOriginalOrder() {
            const tbody = document.getElementById('playlistTracksBody');
            if (tbody) {
                const rows = Array.from(tbody.querySelectorAll('.track-row'));

                // Сортируем по исходной позиции
                rows.sort((a, b) => {
                    const posA = parseInt(a.dataset.position);
                    const posB = parseInt(b.dataset.position);
                    return posA - posB;
                });

                // Перестраиваем таблицу
                rows.forEach(row => {
                    tbody.appendChild(row);
                });

                // Обновляем массив tracks
                tracks.sort((a, b) => a.position - b.position);
            }
        }

        function showToast(message, type) {
            // Простая реализация уведомления через alert
            alert(message);
        }

        // === ГЛОБАЛЬНЫЕ ФУНКЦИИ УПРАВЛЕНИЯ ===

        // Воспроизведение конкретного трека по ID
        window.playTrackFromList = function(id) {
            const index = tracks.findIndex(t => t.id === id);
            if (index !== -1) {
                // Снимаем иконку паузы с предыдущего трека
                updateRowIcon(currentTrackIndex, false);

                currentTrackIndex = index;
                const track = tracks[currentTrackIndex];
                playTrack(track.id, track.title, track.artist, track.duration);
            }
        };

        // Воспроизведение первого трека (кнопка "Слушать")
        window.playFirstTrack = function() {
            if (tracks.length > 0) {
                updateRowIcon(currentTrackIndex, false);
                currentTrackIndex = 0;
                const track = tracks[0];
                playTrack(track.id, track.title, track.artist, track.duration);
            }
        };

        // Основная логика воспроизведения
        window.playTrack = function(trackId, title, artist, duration) {
            // 1. Пауза текущего
            if (currentAudio) {
                currentAudio.pause();
            }

            // 2. Показываем плеер
            const playerElement = document.getElementById('musicPlayer');
            if (playerElement) playerElement.style.display = 'flex';

            // 3. Обновляем тексты в плеере
            document.getElementById('currentTrackName').textContent = title;
            document.getElementById('currentArtistName').textContent = artist;
            document.getElementById('totalTime').textContent = formatTime(duration);

            // 4. Подсветка в таблице
            document.querySelectorAll('.track-row').forEach(row => {
                row.classList.remove('table-active');
                // Сбрасываем иконки кнопок в таблице
                const btnIcon = row.querySelector('.play-track-btn i');
                if(btnIcon) btnIcon.className = 'fas fa-play text-primary';

                if(row.dataset.trackId === trackId) {
                    row.classList.add('table-active');
                    // Ставим иконку паузы для текущего
                    if(btnIcon) btnIcon.className = 'fas fa-pause text-primary';
                }
            });

            // 5. Создаем аудио объект (используем глобальную переменную)
            currentAudio = new Audio(`/Tracks/Stream/${trackId}`);

            currentAudio.addEventListener('timeupdate', updateProgress);
            currentAudio.addEventListener('ended', function() {
                window.nextTrack();
            });
            currentAudio.addEventListener('loadedmetadata', function() {
                if(!isNaN(currentAudio.duration)) {
                   document.getElementById('totalTime').textContent = formatTime(currentAudio.duration);
                }
            });

            // 6. Запуск
            currentAudio.play()
                .then(() => {
                    isPlaying = true;
                    updatePlayButtonIcon();
                })
                .catch(e => console.error("Ошибка:", e));

            // Статистика
            fetch(`/Tracks/RecordPlay/${trackId}`);
        };

        // Пауза / Пуск
        window.togglePlay = function() {
            if (!currentAudio) return;

            if (isPlaying) {
                currentAudio.pause();
            } else {
                currentAudio.play();
            }
            isPlaying = !isPlaying;
            updatePlayButtonIcon();
            updateRowIcon(currentTrackIndex, isPlaying);
        };

        // Следующий трек
        window.nextTrack = function() {
            if (tracks.length === 0) return;

            updateRowIcon(currentTrackIndex, false); // Сброс иконки старого трека

            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            const track = tracks[currentTrackIndex];
            playTrack(track.id, track.title, track.artist, track.duration);
        };

        // Предыдущий трек
        window.previousTrack = function() {
            if (tracks.length === 0) return;

            updateRowIcon(currentTrackIndex, false); // Сброс иконки старого трека

            currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            const track = tracks[currentTrackIndex];
            playTrack(track.id, track.title, track.artist, track.duration);
        };

        // Обновление иконки в самом плеере (внизу страницы)
        function updatePlayButtonIcon() {
            const playIcon = document.getElementById('playIcon');
            if (playIcon) {
                playIcon.className = isPlaying ? 'bi bi-pause' : 'bi bi-play';
            }
        }

        // Обновление иконки в строке таблицы (play/pause)
        function updateRowIcon(index, isPlayingNow) {
            if (!tracks[index]) return;
            const id = tracks[index].id;
            const row = document.querySelector(`.track-row[data-track-id="${id}"]`);
            if (row) {
                const btnIcon = row.querySelector('.play-track-btn i');
                if (btnIcon) {
                    btnIcon.className = isPlayingNow ? 'fas fa-pause text-primary' : 'fas fa-play text-primary';
                }
            }
        }

        // Прогресс бар
        function updateProgress() {
            if (!currentAudio) return;
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');

            if (progressBar && !isNaN(currentAudio.duration)) {
                const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                progressBar.style.width = progress + '%';
            }
            if (currentTimeEl) {
                currentTimeEl.textContent = formatTime(currentAudio.currentTime);
            }
        }

        // Перемотка
        window.seek = function(event) {
            if (!currentAudio) return;
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            currentAudio.currentTime = percent * currentAudio.duration;
        };

        // Вспомогательные
        window.setVolumeGlobal = function(value) {
            if (currentAudio) currentAudio.volume = value / 100;
        };

        window.toggleMuteGlobal = function() {
            if (!currentAudio) return;
            currentAudio.muted = !currentAudio.muted;
            const icon = document.getElementById('volumeIcon');
            if(icon) icon.className = currentAudio.muted ? 'bi bi-volume-mute' : 'bi bi-volume-up';
        };

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
}